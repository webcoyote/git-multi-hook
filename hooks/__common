#!/usr/bin/env bash
# Common utilities for git hooks
# Source this file from pre-commit.d/* scripts:
#   source "$(dirname "${BASH_SOURCE[0]}")/../__common"
# shellcheck disable=SC2034 # (warning): variable appears unused

# Script identification
SCRIPT_NAME="$(basename "${BASH_SOURCE[1]:-${BASH_SOURCE[0]}}")"

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[36m'
GRAY='\033[90m'
NC='\033[0m' # No Color

# Set VERBOSE=non-number to VERBOSE=1, otherwise use the number
[[ "${VERBOSE:-0}" =~ ^[0-9]+$ ]] && VERBOSE="${VERBOSE:-0}" || VERBOSE=1

# Logging functions
trace() {
    [[ "$VERBOSE" -lt 2 ]] || echo >&2 -e "üî¨ ${GRAY}$SCRIPT_NAME: $*${NC}"
}

debug() {
    [[ "$VERBOSE" -lt 1 ]] || echo >&2 -e "üîç ${CYAN}$SCRIPT_NAME: $*${NC}"
}

warn() {
    echo >&2 -e "‚ö†Ô∏è ${YELLOW}$SCRIPT_NAME: $*${NC}"
}

error() {
    echo >&2 -e "‚ùå ${RED}$SCRIPT_NAME: $*${NC}"
}

# Get repository root directory
repo_dir() {
    git rev-parse --show-toplevel
}

# Get staged files (Added, Copied, Modified)
# Usage: get_arguments_or_staged_files extension_pattern file_arguments
#   extension_pattern: regex to filter by extension (e.g., "\.swift$")
#   file_arguments: optional list of files and directories from command line
# Returns: Array of file paths in FILES variable
get_arguments_or_staged_files() {
    FILES=()
    local pattern="$1"
    shift
    if [[ $# -gt 0 ]]; then
        # Use files specified in file_arguments
        for file in "$@"; do
            if [[ -d "$file" ]]; then
                # Find all matching files in the directory
                while IFS= read -r -d '' found_file; do
                    FILES+=("$(realpath "$found_file")")
                done < <(fd --hidden -t f "$pattern" --exclude '.git' -0 "$file")
            else
                # Match file to pattern
                if [[ "$file" =~ $pattern ]]; then
                    FILES+=("$(realpath "$file")")
                fi
            fi
        done
    else
        cd "$(repo_dir)" || exit 1
        local OIFS="$IFS"
        IFS=$'\n'
        for file in $(git diff --staged --name-only --diff-filter=ACM); do
            if [[ "$file" =~ $pattern ]]; then
                FILES+=("$(realpath "$file")")
            fi
        done
        IFS="$OIFS"
    fi
}
